"use strict";(self.webpackChunkclickhouse=self.webpackChunkclickhouse||[]).push([[47377],{3905:function(e,t,n){n.d(t,{Zo:function(){return p},kt:function(){return m}});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),d=c(n),m=r,h=d["".concat(l,".").concat(m)]||d[m]||u[m]||i;return n?a.createElement(h,s(s({ref:t},p),{},{components:n})):a.createElement(h,s({ref:t},p))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,s=new Array(i);s[0]=d;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o.mdxType="string"==typeof e?e:r,s[1]=o;for(var c=2;c<i;c++)s[c]=n[c];return a.createElement.apply(null,s)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},31855:function(e,t,n){n.r(t),n.d(t,{assets:function(){return p},contentTitle:function(){return l},default:function(){return m},frontMatter:function(){return o},metadata:function(){return c},toc:function(){return u}});var a=n(87462),r=n(63366),i=(n(67294),n(3905)),s=["components"],o={sidebar_position:12,sidebar_label:"Tutorial"},l="ClickHouse Tutorial",c={unversionedId:"ru/getting-started/tutorial",id:"ru/getting-started/tutorial",title:"ClickHouse Tutorial",description:"clickhouse-tutorial}",source:"@site/docs/ru/getting-started/tutorial.md",sourceDirName:"ru/getting-started",slug:"/ru/getting-started/tutorial",permalink:"/ru/getting-started/tutorial",editUrl:"https://github.com/ClickHouse/ClickHouse/tree/docs-staging/docs/ru/getting-started/tutorial.md",tags:[],version:"current",sidebarPosition:12,frontMatter:{sidebar_position:12,sidebar_label:"Tutorial"},sidebar:"russia",previous:{title:"\u0423\u0441\u0442\u0430\u043d\u043e\u0432\u043a\u0430",permalink:"/ru/getting-started/install"},next:{title:"\u0422\u0435\u0441\u0442\u043e\u0432\u044b\u0435 \u043c\u0430\u0441\u0441\u0438\u0432\u044b \u0434\u0430\u043d\u043d\u044b\u0445",permalink:"/ru/getting-started/example-datasets/"}},p={},u=[{value:"What to Expect from This Tutorial?",id:"what-to-expect-from-this-tutorial",level:2},{value:"Single Node Setup",id:"single-node-setup",level:2},{value:"Import Sample Dataset",id:"import-sample-dataset",level:2},{value:"Download and Extract Table Data",id:"download-and-extract-table-data",level:3},{value:"Create Tables",id:"create-tables",level:3},{value:"Import Data",id:"import-data",level:3},{value:"Example Queries",id:"example-queries",level:2},{value:"Cluster Deployment",id:"cluster-deployment",level:2}],d={toc:u};function m(e){var t=e.components,n=(0,r.Z)(e,s);return(0,i.kt)("wrapper",(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"clickhouse-tutorial"},"ClickHouse Tutorial"),(0,i.kt)("h2",{id:"what-to-expect-from-this-tutorial"},"What to Expect from This Tutorial?"),(0,i.kt)("p",null,"By going through this tutorial, you\u2019ll learn how to set up a simple ClickHouse cluster. It\u2019ll be small, but fault-tolerant and scalable. Then we will use one of the example datasets to fill it with data and execute some demo queries."),(0,i.kt)("h2",{id:"single-node-setup"},"Single Node Setup"),(0,i.kt)("p",null,"To postpone the complexities of a distributed environment, we\u2019ll start with deploying ClickHouse on a single server or virtual machine. ClickHouse is usually installed from ",(0,i.kt)("a",{parentName:"p",href:"/ru/getting-started/install#install-from-deb-packages"},"deb")," or ",(0,i.kt)("a",{parentName:"p",href:"/ru/getting-started/install#from-rpm-packages"},"rpm")," packages, but there are ",(0,i.kt)("a",{parentName:"p",href:"/ru/getting-started/install#from-docker-image"},"alternatives")," for the operating systems that do no support them."),(0,i.kt)("p",null,"For example, you have chosen ",(0,i.kt)("inlineCode",{parentName:"p"},"deb")," packages and executed:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'sudo apt-get install -y apt-transport-https ca-certificates dirmngr\nsudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 8919F6BD2B48D754\n\necho "deb https://packages.clickhouse.com/deb stable main" | sudo tee \\\n    /etc/apt/sources.list.d/clickhouse.list\nsudo apt-get update\n\nsudo apt-get install -y clickhouse-server clickhouse-client\n\nsudo service clickhouse-server start\nclickhouse-client # or "clickhouse-client --password" if you\'ve set up a password.\n')),(0,i.kt)("p",null,"What do we have in the packages that got installed:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"clickhouse-client")," package contains ",(0,i.kt)("a",{parentName:"li",href:"/ru/interfaces/cli"},"clickhouse-client")," application, interactive ClickHouse console client."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"clickhouse-common")," package contains a ClickHouse executable file."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"clickhouse-server")," package contains configuration files to run ClickHouse as a server.")),(0,i.kt)("p",null,"Server config files are located in ",(0,i.kt)("inlineCode",{parentName:"p"},"/etc/clickhouse-server/"),". Before going further, please notice the ",(0,i.kt)("inlineCode",{parentName:"p"},"<path>")," element in ",(0,i.kt)("inlineCode",{parentName:"p"},"config.xml"),". Path determines the location for data storage, so it should be located on volume with large disk capacity; the default value is ",(0,i.kt)("inlineCode",{parentName:"p"},"/var/lib/clickhouse/"),". If you want to adjust the configuration, it\u2019s not handy to directly edit ",(0,i.kt)("inlineCode",{parentName:"p"},"config.xml")," file, considering it might get rewritten on future package updates. The recommended way to override the config elements is to create ",(0,i.kt)("a",{parentName:"p",href:"/ru/operations/configuration-files"},"files in config.d directory")," which serve as \u201cpatches\u201d to config.xml."),(0,i.kt)("p",null,"As you might have noticed, ",(0,i.kt)("inlineCode",{parentName:"p"},"clickhouse-server")," is not launched automatically after package installation. It won\u2019t be automatically restarted after updates, either. The way you start the server depends on your init system, usually, it is:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"sudo service clickhouse-server start\n")),(0,i.kt)("p",null,"or"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"sudo /etc/init.d/clickhouse-server start\n")),(0,i.kt)("p",null,"The default location for server logs is ",(0,i.kt)("inlineCode",{parentName:"p"},"/var/log/clickhouse-server/"),". The server is ready to handle client connections once it logs the ",(0,i.kt)("inlineCode",{parentName:"p"},"Ready for connections")," message."),(0,i.kt)("p",null,"Once the ",(0,i.kt)("inlineCode",{parentName:"p"},"clickhouse-server")," is up and running, we can use ",(0,i.kt)("inlineCode",{parentName:"p"},"clickhouse-client")," to connect to the server and run some test queries like ",(0,i.kt)("inlineCode",{parentName:"p"},'SELECT "Hello, world!";'),"."),(0,i.kt)("details",{markdown:"1"},(0,i.kt)("summary",null,"Quick tips for clickhouse-client"),(0,i.kt)("p",null,"Interactive mode:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"clickhouse-client\nclickhouse-client --host=... --port=... --user=... --password=...\n")),(0,i.kt)("p",null,"Enable multiline queries:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"clickhouse-client -m\nclickhouse-client --multiline\n")),(0,i.kt)("p",null,"Run queries in batch-mode:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"clickhouse-client --query='SELECT 1'\necho 'SELECT 1' | clickhouse-client\nclickhouse-client <<< 'SELECT 1'\n")),(0,i.kt)("p",null,"Insert data from a file in specified format:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"clickhouse-client --query='INSERT INTO table VALUES' < data.txt\nclickhouse-client --query='INSERT INTO table FORMAT TabSeparated' < data.tsv\n"))),(0,i.kt)("h2",{id:"import-sample-dataset"},"Import Sample Dataset"),(0,i.kt)("p",null,"Now it\u2019s time to fill our ClickHouse server with some sample data. In this tutorial, we\u2019ll use the anonymized data of Yandex.Metrica, the first service that runs ClickHouse in production way before it became open-source (more on that in ",(0,i.kt)("a",{parentName:"p",href:"/ru/introduction/history"},"history section"),"). There are ",(0,i.kt)("a",{parentName:"p",href:"/ru/getting-started/example-datasets/metrica"},"multiple ways to import Yandex.Metrica dataset"),", and for the sake of the tutorial, we\u2019ll go with the most realistic one."),(0,i.kt)("h3",{id:"download-and-extract-table-data"},"Download and Extract Table Data"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},"curl https://datasets.clickhouse.com/hits/tsv/hits_v1.tsv.xz | unxz --threads=`nproc` > hits_v1.tsv\ncurl https://datasets.clickhouse.com/visits/tsv/visits_v1.tsv.xz | unxz --threads=`nproc` > visits_v1.tsv\n")),(0,i.kt)("p",null,"The extracted files are about 10GB in size."),(0,i.kt)("h3",{id:"create-tables"},"Create Tables"),(0,i.kt)("p",null,"As in most databases management systems, ClickHouse logically groups tables into \u201cdatabases\u201d. There\u2019s a ",(0,i.kt)("inlineCode",{parentName:"p"},"default")," database, but we\u2019ll create a new one named ",(0,i.kt)("inlineCode",{parentName:"p"},"tutorial"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'clickhouse-client --query "CREATE DATABASE IF NOT EXISTS tutorial"\n')),(0,i.kt)("p",null,"Syntax for creating tables is way more complicated compared to databases (see ",(0,i.kt)("a",{parentName:"p",href:"/ru/sql-reference/statements/create/table"},"reference"),". In general ",(0,i.kt)("inlineCode",{parentName:"p"},"CREATE TABLE")," statement has to specify three key things:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Name of table to create."),(0,i.kt)("li",{parentName:"ol"},"Table schema, i.e.\xa0list of columns and their ",(0,i.kt)("a",{parentName:"li",href:"/ru/sql-reference/data-types/"},"data types"),"."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("a",{parentName:"li",href:"/ru/engines/table-engines/"},"Table engine")," and its settings, which determines all the details on how queries to this table will be physically executed.")),(0,i.kt)("p",null,"Yandex.Metrica is a web analytics service, and sample dataset doesn\u2019t cover its full functionality, so there are only two tables to create:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"hits")," is a table with each action done by all users on all websites covered by the service."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"visits")," is a table that contains pre-built sessions instead of individual actions.")),(0,i.kt)("p",null,"Let\u2019s see and execute the real create table queries for these tables:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE TABLE tutorial.hits_v1\n(\n    `WatchID` UInt64,\n    `JavaEnable` UInt8,\n    `Title` String,\n    `GoodEvent` Int16,\n    `EventTime` DateTime,\n    `EventDate` Date,\n    `CounterID` UInt32,\n    `ClientIP` UInt32,\n    `ClientIP6` FixedString(16),\n    `RegionID` UInt32,\n    `UserID` UInt64,\n    `CounterClass` Int8,\n    `OS` UInt8,\n    `UserAgent` UInt8,\n    `URL` String,\n    `Referer` String,\n    `URLDomain` String,\n    `RefererDomain` String,\n    `Refresh` UInt8,\n    `IsRobot` UInt8,\n    `RefererCategories` Array(UInt16),\n    `URLCategories` Array(UInt16),\n    `URLRegions` Array(UInt32),\n    `RefererRegions` Array(UInt32),\n    `ResolutionWidth` UInt16,\n    `ResolutionHeight` UInt16,\n    `ResolutionDepth` UInt8,\n    `FlashMajor` UInt8,\n    `FlashMinor` UInt8,\n    `FlashMinor2` String,\n    `NetMajor` UInt8,\n    `NetMinor` UInt8,\n    `UserAgentMajor` UInt16,\n    `UserAgentMinor` FixedString(2),\n    `CookieEnable` UInt8,\n    `JavascriptEnable` UInt8,\n    `IsMobile` UInt8,\n    `MobilePhone` UInt8,\n    `MobilePhoneModel` String,\n    `Params` String,\n    `IPNetworkID` UInt32,\n    `TraficSourceID` Int8,\n    `SearchEngineID` UInt16,\n    `SearchPhrase` String,\n    `AdvEngineID` UInt8,\n    `IsArtifical` UInt8,\n    `WindowClientWidth` UInt16,\n    `WindowClientHeight` UInt16,\n    `ClientTimeZone` Int16,\n    `ClientEventTime` DateTime,\n    `SilverlightVersion1` UInt8,\n    `SilverlightVersion2` UInt8,\n    `SilverlightVersion3` UInt32,\n    `SilverlightVersion4` UInt16,\n    `PageCharset` String,\n    `CodeVersion` UInt32,\n    `IsLink` UInt8,\n    `IsDownload` UInt8,\n    `IsNotBounce` UInt8,\n    `FUniqID` UInt64,\n    `HID` UInt32,\n    `IsOldCounter` UInt8,\n    `IsEvent` UInt8,\n    `IsParameter` UInt8,\n    `DontCountHits` UInt8,\n    `WithHash` UInt8,\n    `HitColor` FixedString(1),\n    `UTCEventTime` DateTime,\n    `Age` UInt8,\n    `Sex` UInt8,\n    `Income` UInt8,\n    `Interests` UInt16,\n    `Robotness` UInt8,\n    `GeneralInterests` Array(UInt16),\n    `RemoteIP` UInt32,\n    `RemoteIP6` FixedString(16),\n    `WindowName` Int32,\n    `OpenerName` Int32,\n    `HistoryLength` Int16,\n    `BrowserLanguage` FixedString(2),\n    `BrowserCountry` FixedString(2),\n    `SocialNetwork` String,\n    `SocialAction` String,\n    `HTTPError` UInt16,\n    `SendTiming` Int32,\n    `DNSTiming` Int32,\n    `ConnectTiming` Int32,\n    `ResponseStartTiming` Int32,\n    `ResponseEndTiming` Int32,\n    `FetchTiming` Int32,\n    `RedirectTiming` Int32,\n    `DOMInteractiveTiming` Int32,\n    `DOMContentLoadedTiming` Int32,\n    `DOMCompleteTiming` Int32,\n    `LoadEventStartTiming` Int32,\n    `LoadEventEndTiming` Int32,\n    `NSToDOMContentLoadedTiming` Int32,\n    `FirstPaintTiming` Int32,\n    `RedirectCount` Int8,\n    `SocialSourceNetworkID` UInt8,\n    `SocialSourcePage` String,\n    `ParamPrice` Int64,\n    `ParamOrderID` String,\n    `ParamCurrency` FixedString(3),\n    `ParamCurrencyID` UInt16,\n    `GoalsReached` Array(UInt32),\n    `OpenstatServiceName` String,\n    `OpenstatCampaignID` String,\n    `OpenstatAdID` String,\n    `OpenstatSourceID` String,\n    `UTMSource` String,\n    `UTMMedium` String,\n    `UTMCampaign` String,\n    `UTMContent` String,\n    `UTMTerm` String,\n    `FromTag` String,\n    `HasGCLID` UInt8,\n    `RefererHash` UInt64,\n    `URLHash` UInt64,\n    `CLID` UInt32,\n    `YCLID` UInt64,\n    `ShareService` String,\n    `ShareURL` String,\n    `ShareTitle` String,\n    `ParsedParams` Nested(\n        Key1 String,\n        Key2 String,\n        Key3 String,\n        Key4 String,\n        Key5 String,\n        ValueDouble Float64),\n    `IslandID` FixedString(16),\n    `RequestNum` UInt32,\n    `RequestTry` UInt8\n)\nENGINE = MergeTree()\nPARTITION BY toYYYYMM(EventDate)\nORDER BY (CounterID, EventDate, intHash32(UserID))\nSAMPLE BY intHash32(UserID)\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE TABLE tutorial.visits_v1\n(\n    `CounterID` UInt32,\n    `StartDate` Date,\n    `Sign` Int8,\n    `IsNew` UInt8,\n    `VisitID` UInt64,\n    `UserID` UInt64,\n    `StartTime` DateTime,\n    `Duration` UInt32,\n    `UTCStartTime` DateTime,\n    `PageViews` Int32,\n    `Hits` Int32,\n    `IsBounce` UInt8,\n    `Referer` String,\n    `StartURL` String,\n    `RefererDomain` String,\n    `StartURLDomain` String,\n    `EndURL` String,\n    `LinkURL` String,\n    `IsDownload` UInt8,\n    `TraficSourceID` Int8,\n    `SearchEngineID` UInt16,\n    `SearchPhrase` String,\n    `AdvEngineID` UInt8,\n    `PlaceID` Int32,\n    `RefererCategories` Array(UInt16),\n    `URLCategories` Array(UInt16),\n    `URLRegions` Array(UInt32),\n    `RefererRegions` Array(UInt32),\n    `IsYandex` UInt8,\n    `GoalReachesDepth` Int32,\n    `GoalReachesURL` Int32,\n    `GoalReachesAny` Int32,\n    `SocialSourceNetworkID` UInt8,\n    `SocialSourcePage` String,\n    `MobilePhoneModel` String,\n    `ClientEventTime` DateTime,\n    `RegionID` UInt32,\n    `ClientIP` UInt32,\n    `ClientIP6` FixedString(16),\n    `RemoteIP` UInt32,\n    `RemoteIP6` FixedString(16),\n    `IPNetworkID` UInt32,\n    `SilverlightVersion3` UInt32,\n    `CodeVersion` UInt32,\n    `ResolutionWidth` UInt16,\n    `ResolutionHeight` UInt16,\n    `UserAgentMajor` UInt16,\n    `UserAgentMinor` UInt16,\n    `WindowClientWidth` UInt16,\n    `WindowClientHeight` UInt16,\n    `SilverlightVersion2` UInt8,\n    `SilverlightVersion4` UInt16,\n    `FlashVersion3` UInt16,\n    `FlashVersion4` UInt16,\n    `ClientTimeZone` Int16,\n    `OS` UInt8,\n    `UserAgent` UInt8,\n    `ResolutionDepth` UInt8,\n    `FlashMajor` UInt8,\n    `FlashMinor` UInt8,\n    `NetMajor` UInt8,\n    `NetMinor` UInt8,\n    `MobilePhone` UInt8,\n    `SilverlightVersion1` UInt8,\n    `Age` UInt8,\n    `Sex` UInt8,\n    `Income` UInt8,\n    `JavaEnable` UInt8,\n    `CookieEnable` UInt8,\n    `JavascriptEnable` UInt8,\n    `IsMobile` UInt8,\n    `BrowserLanguage` UInt16,\n    `BrowserCountry` UInt16,\n    `Interests` UInt16,\n    `Robotness` UInt8,\n    `GeneralInterests` Array(UInt16),\n    `Params` Array(String),\n    `Goals` Nested(\n        ID UInt32,\n        Serial UInt32,\n        EventTime DateTime,\n        Price Int64,\n        OrderID String,\n        CurrencyID UInt32),\n    `WatchIDs` Array(UInt64),\n    `ParamSumPrice` Int64,\n    `ParamCurrency` FixedString(3),\n    `ParamCurrencyID` UInt16,\n    `ClickLogID` UInt64,\n    `ClickEventID` Int32,\n    `ClickGoodEvent` Int32,\n    `ClickEventTime` DateTime,\n    `ClickPriorityID` Int32,\n    `ClickPhraseID` Int32,\n    `ClickPageID` Int32,\n    `ClickPlaceID` Int32,\n    `ClickTypeID` Int32,\n    `ClickResourceID` Int32,\n    `ClickCost` UInt32,\n    `ClickClientIP` UInt32,\n    `ClickDomainID` UInt32,\n    `ClickURL` String,\n    `ClickAttempt` UInt8,\n    `ClickOrderID` UInt32,\n    `ClickBannerID` UInt32,\n    `ClickMarketCategoryID` UInt32,\n    `ClickMarketPP` UInt32,\n    `ClickMarketCategoryName` String,\n    `ClickMarketPPName` String,\n    `ClickAWAPSCampaignName` String,\n    `ClickPageName` String,\n    `ClickTargetType` UInt16,\n    `ClickTargetPhraseID` UInt64,\n    `ClickContextType` UInt8,\n    `ClickSelectType` Int8,\n    `ClickOptions` String,\n    `ClickGroupBannerID` Int32,\n    `OpenstatServiceName` String,\n    `OpenstatCampaignID` String,\n    `OpenstatAdID` String,\n    `OpenstatSourceID` String,\n    `UTMSource` String,\n    `UTMMedium` String,\n    `UTMCampaign` String,\n    `UTMContent` String,\n    `UTMTerm` String,\n    `FromTag` String,\n    `HasGCLID` UInt8,\n    `FirstVisit` DateTime,\n    `PredLastVisit` Date,\n    `LastVisit` Date,\n    `TotalVisits` UInt32,\n    `TraficSource` Nested(\n        ID Int8,\n        SearchEngineID UInt16,\n        AdvEngineID UInt8,\n        PlaceID UInt16,\n        SocialSourceNetworkID UInt8,\n        Domain String,\n        SearchPhrase String,\n        SocialSourcePage String),\n    `Attendance` FixedString(16),\n    `CLID` UInt32,\n    `YCLID` UInt64,\n    `NormalizedRefererHash` UInt64,\n    `SearchPhraseHash` UInt64,\n    `RefererDomainHash` UInt64,\n    `NormalizedStartURLHash` UInt64,\n    `StartURLDomainHash` UInt64,\n    `NormalizedEndURLHash` UInt64,\n    `TopLevelDomain` UInt64,\n    `URLScheme` UInt64,\n    `OpenstatServiceNameHash` UInt64,\n    `OpenstatCampaignIDHash` UInt64,\n    `OpenstatAdIDHash` UInt64,\n    `OpenstatSourceIDHash` UInt64,\n    `UTMSourceHash` UInt64,\n    `UTMMediumHash` UInt64,\n    `UTMCampaignHash` UInt64,\n    `UTMContentHash` UInt64,\n    `UTMTermHash` UInt64,\n    `FromHash` UInt64,\n    `WebVisorEnabled` UInt8,\n    `WebVisorActivity` UInt32,\n    `ParsedParams` Nested(\n        Key1 String,\n        Key2 String,\n        Key3 String,\n        Key4 String,\n        Key5 String,\n        ValueDouble Float64),\n    `Market` Nested(\n        Type UInt8,\n        GoalID UInt32,\n        OrderID String,\n        OrderPrice Int64,\n        PP UInt32,\n        DirectPlaceID UInt32,\n        DirectOrderID UInt32,\n        DirectBannerID UInt32,\n        GoodID String,\n        GoodName String,\n        GoodQuantity Int32,\n        GoodPrice Int64),\n    `IslandID` FixedString(16)\n)\nENGINE = CollapsingMergeTree(Sign)\nPARTITION BY toYYYYMM(StartDate)\nORDER BY (CounterID, StartDate, intHash32(UserID), VisitID)\nSAMPLE BY intHash32(UserID)\n")),(0,i.kt)("p",null,"You can execute those queries using the interactive mode of ",(0,i.kt)("inlineCode",{parentName:"p"},"clickhouse-client")," (just launch it in a terminal without specifying a query in advance) or try some ",(0,i.kt)("a",{parentName:"p",href:"/ru/interfaces/"},"alternative interface")," if you want."),(0,i.kt)("p",null,"As we can see, ",(0,i.kt)("inlineCode",{parentName:"p"},"hits_v1")," uses the ",(0,i.kt)("a",{parentName:"p",href:"/ru/engines/table-engines/mergetree-family/mergetree"},"basic MergeTree engine"),", while the ",(0,i.kt)("inlineCode",{parentName:"p"},"visits_v1")," uses the ",(0,i.kt)("a",{parentName:"p",href:"/ru/engines/table-engines/mergetree-family/collapsingmergetree"},"Collapsing")," variant."),(0,i.kt)("h3",{id:"import-data"},"Import Data"),(0,i.kt)("p",null,"Data import to ClickHouse is done via ",(0,i.kt)("a",{parentName:"p",href:"/ru/sql-reference/statements/insert-into"},"INSERT INTO")," query like in many other SQL databases. However, data is usually provided in one of the ",(0,i.kt)("a",{parentName:"p",href:"/ru/interfaces/formats"},"supported serialization formats")," instead of ",(0,i.kt)("inlineCode",{parentName:"p"},"VALUES")," clause (which is also supported)."),(0,i.kt)("p",null,"The files we downloaded earlier are in tab-separated format, so here\u2019s how to import them via console client:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'clickhouse-client --query "INSERT INTO tutorial.hits_v1 FORMAT TSV" --max_insert_block_size=100000 < hits_v1.tsv\nclickhouse-client --query "INSERT INTO tutorial.visits_v1 FORMAT TSV" --max_insert_block_size=100000 < visits_v1.tsv\n')),(0,i.kt)("p",null,"ClickHouse has a lot of ",(0,i.kt)("a",{parentName:"p",href:"/ru/operations/settings/overview"},"settings to tune")," and one way to specify them in console client is via arguments, as we can see with ",(0,i.kt)("inlineCode",{parentName:"p"},"--max_insert_block_size"),". The easiest way to figure out what settings are available, what do they mean and what the defaults are is to query the ",(0,i.kt)("inlineCode",{parentName:"p"},"system.settings")," table:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT name, value, changed, description\nFROM system.settings\nWHERE name LIKE '%max_insert_b%'\nFORMAT TSV\n\nmax_insert_block_size    1048576    0    \"The maximum block size for insertion, if we control the creation of blocks for insertion.\"\n")),(0,i.kt)("p",null,"Optionally you can ",(0,i.kt)("a",{parentName:"p",href:"/ru/sql-reference/statements/misc#misc_operations-optimize"},"OPTIMIZE")," the tables after import. Tables that are configured with an engine from MergeTree-family always do merges of data parts in the background to optimize data storage (or at least check if it makes sense). These queries force the table engine to do storage optimization right now instead of some time later:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'clickhouse-client --query "OPTIMIZE TABLE tutorial.hits_v1 FINAL"\nclickhouse-client --query "OPTIMIZE TABLE tutorial.visits_v1 FINAL"\n')),(0,i.kt)("p",null,"These queries start an I/O and CPU intensive operation, so if the table consistently receives new data, it\u2019s better to leave it alone and let merges run in the background."),(0,i.kt)("p",null,"Now we can check if the table import was successful:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'clickhouse-client --query "SELECT COUNT(*) FROM tutorial.hits_v1"\nclickhouse-client --query "SELECT COUNT(*) FROM tutorial.visits_v1"\n')),(0,i.kt)("h2",{id:"example-queries"},"Example Queries"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT\n    StartURL AS URL,\n    AVG(Duration) AS AvgDuration\nFROM tutorial.visits_v1\nWHERE StartDate BETWEEN '2014-03-23' AND '2014-03-30'\nGROUP BY URL\nORDER BY AvgDuration DESC\nLIMIT 10\n")),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT\n    sum(Sign) AS visits,\n    sumIf(Sign, has(Goals.ID, 1105530)) AS goal_visits,\n    (100. * goal_visits) / visits AS goal_percent\nFROM tutorial.visits_v1\nWHERE (CounterID = 912887) AND (toYYYYMM(StartDate) = 201403) AND (domain(StartURL) = 'yandex.ru')\n")),(0,i.kt)("h2",{id:"cluster-deployment"},"Cluster Deployment"),(0,i.kt)("p",null,"ClickHouse cluster is a homogenous cluster. Steps to set up:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Install ClickHouse server on all machines of the cluster"),(0,i.kt)("li",{parentName:"ol"},"Set up cluster configs in configuration files"),(0,i.kt)("li",{parentName:"ol"},"Create local tables on each instance"),(0,i.kt)("li",{parentName:"ol"},"Create a ",(0,i.kt)("a",{parentName:"li",href:"/ru/engines/table-engines/special/distributed"},"Distributed table"))),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"/ru/engines/table-engines/special/distributed"},"Distributed table")," is actually a kind of \u201cview\u201d to local tables of ClickHouse cluster. SELECT query from a distributed table executes using resources of all cluster\u2019s shards. You may specify configs for multiple clusters and create multiple distributed tables providing views to different clusters."),(0,i.kt)("p",null,"Example config for a cluster with three shards, one replica each:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-xml"},"<remote_servers>\n    <perftest_3shards_1replicas>\n        <shard>\n            <replica>\n                <host>example-perftest01j.yandex.ru</host>\n                <port>9000</port>\n            </replica>\n        </shard>\n        <shard>\n            <replica>\n                <host>example-perftest02j.yandex.ru</host>\n                <port>9000</port>\n            </replica>\n        </shard>\n        <shard>\n            <replica>\n                <host>example-perftest03j.yandex.ru</host>\n                <port>9000</port>\n            </replica>\n        </shard>\n    </perftest_3shards_1replicas>\n</remote_servers>\n")),(0,i.kt)("p",null,"For further demonstration, let\u2019s create a new local table with the same ",(0,i.kt)("inlineCode",{parentName:"p"},"CREATE TABLE")," query that we used for ",(0,i.kt)("inlineCode",{parentName:"p"},"hits_v1"),", but different table name:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE TABLE tutorial.hits_local (...) ENGINE = MergeTree() ...\n")),(0,i.kt)("p",null,"Creating a distributed table providing a view into local tables of the cluster:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE TABLE tutorial.hits_all AS tutorial.hits_local\nENGINE = Distributed(perftest_3shards_1replicas, tutorial, hits_local, rand());\n")),(0,i.kt)("p",null,"A common practice is to create similar Distributed tables on all machines of the cluster. It allows running distributed queries on any machine of the cluster. Also there\u2019s an alternative option to create temporary distributed table for a given SELECT query using ",(0,i.kt)("a",{parentName:"p",href:"/ru/sql-reference/table-functions/remote"},"remote")," table function."),(0,i.kt)("p",null,"Let\u2019s run ",(0,i.kt)("a",{parentName:"p",href:"/ru/sql-reference/statements/insert-into"},"INSERT SELECT")," into the Distributed table to spread the table to multiple servers."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-sql"},"INSERT INTO tutorial.hits_all SELECT * FROM tutorial.hits_v1;\n")),(0,i.kt)("div",{className:"admonition admonition-danger alert alert--danger"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"}))),'"Notice"')),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("pre",{parentName:"div"},(0,i.kt)("code",{parentName:"pre"},"This approach is not suitable for the sharding of large tables. There\u2019s a separate tool [clickhouse-copier](/ru/operations/utilities/clickhouse-copier) that can re-shard arbitrary large tables.\n")),(0,i.kt)("p",{parentName:"div"},"As you could expect, computationally heavy queries run N times faster if they utilize 3 servers instead of one."),(0,i.kt)("p",{parentName:"div"},"In this case, we have used a cluster with 3 shards, and each contains a single replica."),(0,i.kt)("p",{parentName:"div"},"To provide resilience in a production environment, we recommend that each shard should contain 2-3 replicas spread between multiple availability zones or datacenters (or at least racks). Note that ClickHouse supports an unlimited number of replicas."),(0,i.kt)("p",{parentName:"div"},"Example config for a cluster of one shard containing three replicas:"),(0,i.kt)("pre",{parentName:"div"},(0,i.kt)("code",{parentName:"pre",className:"language-xml"},"<remote_servers>\n    ...\n    <perftest_1shards_3replicas>\n        <shard>\n            <replica>\n                <host>example-perftest01j.yandex.ru</host>\n                <port>9000</port>\n             </replica>\n             <replica>\n                <host>example-perftest02j.yandex.ru</host>\n                <port>9000</port>\n             </replica>\n             <replica>\n                <host>example-perftest03j.yandex.ru</host>\n                <port>9000</port>\n             </replica>\n        </shard>\n    </perftest_1shards_3replicas>\n</remote_servers>\n")),(0,i.kt)("p",{parentName:"div"},"To enable native replication ",(0,i.kt)("a",{parentName:"p",href:"http://zookeeper.apache.org/"},"ZooKeeper")," is required. ClickHouse takes care of data consistency on all replicas and runs restore procedure after failure automatically. It\u2019s recommended to deploy the ZooKeeper cluster on separate servers (where no other processes including ClickHouse are running)."),(0,i.kt)("pre",{parentName:"div"},(0,i.kt)("code",{parentName:"pre"},':::note "Note"\nZooKeeper is not a strict requirement: in some simple cases, you can duplicate the data by writing it into all the replicas from your application code. This approach is **not** recommended, in this case, ClickHouse won\u2019t be able to guarantee data consistency on all replicas. Thus it becomes the responsibility of your application.\n:::\n')),(0,i.kt)("p",{parentName:"div"},"ZooKeeper locations are specified in the configuration file:"),(0,i.kt)("pre",{parentName:"div"},(0,i.kt)("code",{parentName:"pre",className:"language-xml"},"<zookeeper>\n    <node>\n        <host>zoo01.yandex.ru</host>\n        <port>2181</port>\n    </node>\n    <node>\n        <host>zoo02.yandex.ru</host>\n        <port>2181</port>\n    </node>\n    <node>\n        <host>zoo03.yandex.ru</host>\n        <port>2181</port>\n    </node>\n</zookeeper>\n")),(0,i.kt)("p",{parentName:"div"},"Also, we need to set macros for identifying each shard and replica which are used on table creation:"),(0,i.kt)("pre",{parentName:"div"},(0,i.kt)("code",{parentName:"pre",className:"language-xml"},"<macros>\n    <shard>01</shard>\n    <replica>01</replica>\n</macros>\n")),(0,i.kt)("p",{parentName:"div"},"If there are no replicas at the moment on replicated table creation, a new first replica is instantiated. If there are already live replicas, the new replica clones data from existing ones. You have an option to create all replicated tables first, and then insert data to it. Another option is to create some replicas and add the others after or during data insertion."),(0,i.kt)("pre",{parentName:"div"},(0,i.kt)("code",{parentName:"pre",className:"language-sql"},"CREATE TABLE tutorial.hits_replica (...)\nENGINE = ReplicatedMergeTree(\n    '/clickhouse_perftest/tables/{shard}/hits',\n    '{replica}'\n)\n...\n")),(0,i.kt)("p",{parentName:"div"},"Here we use ",(0,i.kt)("a",{parentName:"p",href:"/ru/engines/table-engines/mergetree-family/replication"},"ReplicatedMergeTree")," table engine. In parameters we specify ZooKeeper path containing shard and replica identifiers."),(0,i.kt)("pre",{parentName:"div"},(0,i.kt)("code",{parentName:"pre",className:"language-sql"},"INSERT INTO tutorial.hits_replica SELECT * FROM tutorial.hits_local;\n")),(0,i.kt)("p",{parentName:"div"},"Replication operates in multi-master mode. Data can be loaded into any replica, and the system then syncs it with other instances automatically. Replication is asynchronous so at a given moment, not all replicas may contain recently inserted data. At least one replica should be up to allow data ingestion. Others will sync up data and repair consistency once they will become active again. Note that this approach allows for the low possibility of a loss of recently inserted data."),(0,i.kt)("p",{parentName:"div"},(0,i.kt)("a",{parentName:"p",href:"https://clickhouse.com/docs/en/getting_started/tutorial/"},"Original article")," "))))}m.isMDXComponent=!0}}]);